---
title: 'Final Project, P3: EDA'
author: "Nathaniel Evans, ALfonso Poire, Wei-Chun Lin"
date: "November 23, 2018"
output:
  html_document: 
    theme: flatly 
    highlight: kate
    toc: true
    toc_depth: 2
    toc_float : true
    smooth_scroll: true
    number_sections : true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)

```

# Overview

### PAPER: [Hair cortisol levels, psychological stress and psychopathological symptoms as predictors of postpartum depression](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0182817) 
### DATA: [sav file](https://figshare.com/articles/PPD_hairCortisol_PlosOne_sav/5255848/1) 
### TIDY DATA: [csv file](./../../data/tidy_daya.csv)
### CODE BOOK: [knitted html](./group7_codebook.html)

#### The purpose of this R markdown script is to explore the data provided by this paper. If desired, you can clone the the [github repository](https://github.com/OHSU-Math630/FINAL_PROJECT) and access this script within the cloned file strucutre (located: FINAL_PROJECT/postpartum_depression_predicition/P2/group7_DataDelivery.Rmd). 

## Load Tidy Dataset 

```{r}
getwd()

load('../../data/tidy_data.Rdata')

pp_sad <- df_tidy # rename meaningful 

``` 

# Examine Raw Data 
### All the variables are of a numeric type, although, many are discrete options that are mapped to categorical variables in the codebook. 

### For more in-depth summary of each variable, please refer to our codebook, submitted with this Project. 

```{r}
glimpse(pp_sad)

# summary(pp_sad) # all data is better displayed in codebook
```


# Biological predictors of Postparatum Depression 

##Depression to PP threshold
### How does depression scores map to postpartum_depression labels? Might there be a better threshold cuttoff?

From the overall epds population density, it is a fairly apparent a bi-modal distribution, which explains the cutoff point. As a population segmentation, it makes sense, but it might be interesting to examine the extreme values to look for higher correllation. 

```{r}
pp_sad %>% ggplot() + geom_density(aes(x=epds, group=postpartum_depression, fill = postpartum_depression, alpha=0.3, bins=50)) 

pp_sad %>% ggplot() + geom_density(aes(x=epds, fill = 'total', alpha=0.3)) 
```

## Cortisol vs Depression
### This section explores the relationships between the various trimesters and the levls of cortisol or the depression index score.

The accuracy of the tables seem to be dependent on the trimester when the test is taken they are more accurate in the third trimester then the first this is to be expected. however the means do not seem to vary much even in the third trimester so perhaps this is not a very accurate method regardless. trimester 2 seems to be the most infulential predictor. 


### Comparing Postpartum Depression factors against the trimester depression metrics. How does depression during pregnancy effect postpartum depression? 

```{r}
#variation of depression scores in trimesters seperated by outcome of post partum depression or not 

pp_sad %>% ggplot() + geom_density(aes(x=depression_tri1, fill='tri1', alpha = 0.3)) + geom_density(aes(x=depression_tri2, fill='tri2', alpha = 0.3)) + geom_density(aes(x=depression_tri3, fill='tri3', alpha = 0.3)) + facet_wrap(~postpartum_depression) + ggtitle('trimester depression populations by postpartum outcome') + xlab('depression score')

pp_sad %>% ggplot() + geom_density(aes(x=depression_tri1, group=as.factor(postpartum_depression), fill=postpartum_depression, alpha=0.25))


pp_sad %>% ggplot() + geom_density(aes(x=depression_tri2, group=as.factor(postpartum_depression), fill=as.factor(postpartum_depression), alpha = 0.25))


pp_sad %>% ggplot() + geom_density(aes(x=depression_tri3, group=as.factor(postpartum_depression), fill=as.factor(postpartum_depression), alpha = 0.25))

```

```{r}
pp_sad %>% ggplot() + geom_violin(aes(x=postpartum_depression,y=depression_tri1,group=postpartum_depression, fill='tri1', alpha=0.3)) + geom_violin(aes(x=postpartum_depression,y=depression_tri2,group=postpartum_depression, fill='tri2', alpha=0.3)) + geom_violin(aes(x=postpartum_depression,y=depression_tri3,group=postpartum_depression, fill='tri3', alpha=0.3))

#same info shown in boxplots
ggplot(pp_sad,aes(x=postpartum_depression,y=depression_tri1,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=postpartum_depression,y=depression_tri2,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=postpartum_depression,y=depression_tri3,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()
```

### How does cortisol during each trimester relate to postpartum depression

```{r}
pp_sad %>% ggplot() + geom_density(aes(x=cortisol_tri1, fill='tri1', alpha = 0.3)) + geom_density(aes(x=cortisol_tri2, fill='tri2', alpha = 0.3)) + geom_density(aes(x=cortisol_tri3, fill='tri3', alpha = 0.3)) + facet_wrap(~postpartum_depression) + ggtitle('trimester cortisol populations by postpartum outcome') + xlab('cortisol level')

pp_sad %>% ggplot() + geom_density(aes(x=cortisol_tri1, group=as.factor(postpartum_depression), fill=postpartum_depression, alpha=0.25))


pp_sad %>% ggplot() + geom_density(aes(x=cortisol_tri2, group=as.factor(postpartum_depression), fill=as.factor(postpartum_depression), alpha = 0.25))


pp_sad %>% ggplot() + geom_density(aes(x=cortisol_tri3, group=as.factor(postpartum_depression), fill=as.factor(postpartum_depression), alpha = 0.25))

```

```{r}
ggplot(pp_sad,aes(x=postpartum_depression,y=cortisol_tri1,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=postpartum_depression,y=cortisol_tri2,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=postpartum_depression,y=cortisol_tri3,group=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_boxplot()+
  theme_gray()




```

##PP_depression vs Employment Status
###Relationship between postpartum depression and employment status

This section seemed important as the stress from being emoployed or not seeme like it would have an effect on the cortosol levles of the individual as well as the depression scores related. as such thoughs two paramaters were compaired to employment status. 

### The purpose of the following explorations are to answer the questions:
#### how does cortisol and other variables interact? 
#### are there significant colinearities? 

#### A big worry here is, which of these variables are causal and which are merely correllated? Does cortisol trail any other variables? Are there stronger correllations between pp depression and other non-biological variables? Are cortisol levels more a response to behavioral/pyscological variables? and thus cortisol level is an intermediary method of prediction? 

```{r}
ggplot(pp_sad,aes(x=employed,y=cortisol_tri1,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=employed,y=cortisol_tri2,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=employed,y=cortisol_tri3,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
```
```{r}
ggplot(pp_sad,aes(x=employed,y=depression_tri1,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=employed,y=depression_tri2,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=employed,y=depression_tri3,group=employed,fill=as.factor(employed)))+
  geom_boxplot()+
  theme_gray()
```

## Depression Score vs Cortisol
###Relationship between job type and depression score and cortosol levels

We also investigated the relationship between job type and cortosol and depression scores as we thought that this two would affect the results. There does seem to be some correlation here between having a job and depression score but not so much cortosol levels.

```{r}
ggplot(pp_sad,aes(x=occupation,y=depression_tri1,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=occupation,y=depression_tri2,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=occupation,y=depression_tri3,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
```
```{r}
ggplot(pp_sad,aes(x=occupation,y=cortisol_tri1,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=occupation,y=cortisol_tri2,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
ggplot(pp_sad,aes(x=occupation,y=cortisol_tri3,group=occupation,fill=as.factor(occupation)))+
  geom_boxplot()+
  theme_gray()
```


##Occupation vs Postpartum depression

while employment type dosent seem to have to much of an effect on postpartum depression it would seem that being unemployed does 

```{r}
ggplot(pp_sad,aes(x=occupation,y=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_col()+
  theme_gray()

```


##Employment vs Postpartum depression


```{r}
ggplot(pp_sad,aes(x=employed,y=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_col()+
  theme_gray()
```


##Wanted/Unwanted vs PP_depression

This seemed to have remarkably little affect
```{r}
ggplot(pp_sad,aes(x=wanted_pregnancy,y=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_col()+
  theme_gray()

```

## First Pregnancy vs PP_depression

```{r}
ggplot(pp_sad,aes(x=first_pregnancy,y=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_col()+
  theme_gray()
```

##Sex of Fetus vs Depression

```{r}
ggplot(pp_sad,aes(x=fetus_sex,y=postpartum_depression,fill=as.factor(postpartum_depression)))+
  geom_col()+
  theme_gray()


```

##Cortisol, Depression Relation across Trimesters

### These are very interesting, the two labels show significantly different, but stable trends. 

#### This is indicative that depression scores are not reliably correllated to cortisol levels and thus a potentially poor metric to try and predict postparatum depression 


```{r}
ggplot(pp_sad,aes(x=depression_tri1,y=cortisol_tri1,color=as.factor(postpartum_depression))) +geom_point()+geom_smooth(method = "lm", se = FALSE, show.legend=FALSE)

ggplot(pp_sad,aes(x=depression_tri2,y=cortisol_tri2,color= as.factor(postpartum_depression)))+geom_point()+geom_smooth(method = "lm", se = FALSE)

ggplot(pp_sad,aes(x=depression_tri3,y=cortisol_tri3,color=as.factor(postpartum_depression))) +geom_point()+geom_smooth(method = "lm", se = FALSE)

X = c(pp_sad$depression_tri1, pp_sad$depression_tri2, pp_sad$depression_tri3)
Y = c(pp_sad$cortisol_tri1, pp_sad$cortisol_tri2, pp_sad$cortisol_tri3)
df2 <- data.frame(x=X, y=Y) %>% drop_na()

ggplot(data = df2, aes(x=x,y=y)) + geom_point() + geom_smooth(method = "lm", se = TRUE)
```

#Colinearlity Analysis

### Do we have colinearity between variables? What do we want to avoid including in our model?

There is significant colinearity between the biological and psychological metrics. This makes me question the validity of our biological predictor (cortisol). I find it unlikely to think that cortisol is the causal effect of postparatum depression, rather, more likely is that it is a response to stress from depression inducing lifestyles or events. This does not necessarily make it value-less, but as a mechanistic predictor, I'd be wary. 

```{r}
# we should really only check continuous variables 

.cor <- pp_sad %>% select(starts_with('cortisol'), starts_with('depression'), age, epds, education_level, fetus_sex, previous_miscarriage) %>% cor()
library(reshape2)
melted_sad <- melt(.cor)

ggplot(data = melted_sad, aes(x=Var1, y=Var2, fill=value)) + geom_tile() +  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Pearson\nCorrelation") +  theme(axis.text.x = element_text(angle = 60, vjust = 1, 
    size = 12, hjust = 1))
```

